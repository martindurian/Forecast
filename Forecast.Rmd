---
title: "Energy consumption estimation"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, warning = FALSE, message=FALSE)
```


## Data preparation

```{r load section}
library(tidyverse)
library(tsibble)
library(lubridate)
library(feasts) #tsibbledata, feasts, fable
library(cowplot)
library(ggwrap)
library(fable)
library(fable.prophet)
library(fabletools)

source("C:/Users/sk0007/OneDrive - Daikin Europe N.V/Documents/R scripts/DCS/DCS/MasterSctripts/Various_data_structures.R", encoding = "UTF-8")
# working_path <- "C:/Users/sk0007/OneDrive - Daikin Europe N.V/Documents/R scripts/DCS/DCS/DACE CZ Office/2018_2019 whole years"
source("C:/Users/sk0007/OneDrive - Daikin Europe N.V/Documents/R scripts/DCS/DCS/MasterSctripts/Functions.R")
# load(file=file.path(working_path, "Data_structure.Rda"))

buildings_to_include <- c(123, 118, 116, 113, 111, 109, 108, 107, 102, 97, 96, 44)
# buildings_to_include <- c(123, 116, 109)
building_data_files_rows <- slice(building_data_files, buildings_to_include)

# report_file_name <- paste(building_data_files_row$Building,building_data_files_row$calc_timestamp)

```


```{r Data preparation}
# data frame preparation -----
# include Te, Tc into dataframe
prepare_df_fun <- function(Data_struct_fun) map(Data_struct_fun$Out_DF_list_outdoors, function (outdoor_df){

outdoor_inc_tec_df <- outdoor_df %>%
  mutate(OpeMode=if_else(Cooling.capacity==0 & Heating.capacity==0 & Operation.control.mode == "Heat recovery normal control", "HeRec", OpeMode)) %>% 
  select(TimeStampPosixct, consumption = Watt.hour.amount.Corrected., ambient = O.U.1.outside.air.temp., OpeMode, UniqueIdentifier, SystemIdentifier, ope_time_out = Outdoor.unit.operation.time, matches('^Te.mean.value|^Tc.mean.value|^Tes.mean.value|^Tcs.mean.value')) %>%   #'^T.*\\.mean\\.value' %>% 
  mutate(consumption = replace(consumption, consumption == 0, 0.015), dummy.worktime_out = if_else(ope_time_out == 0, 0, 1)) %>% 
  arrange(TimeStampPosixct)

sys_ident <- unique(outdoor_inc_tec_df$SystemIdentifier)

# indoor average sepotints -----
indoors_average_values <- Data_struct_fun %>% 
  pluck("Merged_Indoor_Units") %>%
  arrange(TimeStampPosixct) %>% 
  filter(SystemIdentifier %in% sys_ident) %>% 
  select(TimeStampPosixct, Avg..setting.temp., Indoor.unit.operation.time.accumulation, Suction.air.temp., UnitType, SystemIdentifier, UniqueIdentifier) %>% 
  mutate(Suction.air.temp. = replace(Suction.air.temp., Suction.air.temp. == 0, NA)) %>% 
  group_by(UniqueIdentifier) %>% 
  fill(Avg..setting.temp., .direction = "downup") %>% 
  ungroup() %>% 
  mutate(unit_size = get_unit_size(UnitType), 
         setpoint_factor = Avg..setting.temp.*unit_size, 
         ope_time_factor = Indoor.unit.operation.time.accumulation/60 * unit_size,
         suction_factor = Suction.air.temp. * unit_size,
         suction_factor_opetime = Suction.air.temp. * unit_size * Indoor.unit.operation.time.accumulation/60) %>% 
  group_by(TimeStampPosixct) %>% 
  summarise(setpoint_factor_sum = sum(setpoint_factor, na.rm = TRUE), 
            unit_size_sum = sum(unit_size, na.rm = TRUE), 
            average_setpoint=setpoint_factor_sum/unit_size_sum,
            ope_time_factor_sum = sum(ope_time_factor, na.rm = TRUE), 
            average_ope_time = ope_time_factor_sum/unit_size_sum, 
            suction_factor_sum = sum(suction_factor, na.rm = TRUE),
            suction_factor_opetime_sum = sum(suction_factor_opetime, na.rm = TRUE),
            average_suction = suction_factor_sum/unit_size_sum,
            average_suction_opetime = if_else(ope_time_factor_sum == 0, average_suction ,suction_factor_opetime_sum/ope_time_factor_sum)) %>% 
  ungroup() %>% 
  mutate(average_suction = replace_na(average_suction, 0), dummy.worktime = if_else(average_ope_time == 0, 0, 1))%>% 
  select(-contains("sum"))

total_inc_tec_tsbl <- outdoor_inc_tec_df %>% 
  left_join(indoors_average_values, by="TimeStampPosixct") %>% 
  group_by(TimeStampPosixct) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  arrange(TimeStampPosixct) %>% 
  as_tsibble(index = TimeStampPosixct, key = UniqueIdentifier) %>% 
  fill_gaps() %>% 
  fill(everything(), .direction = "downup") %>% 
  mutate(hd = hour(TimeStampPosixct), my = month(TimeStampPosixct), wd = wday(TimeStampPosixct, week_start = getOption("lubridate.week.start", 1)), OpeMode = factor(OpeMode, levels = c("Cooling", "Heating", "HeRec", "Both", "Idle"))) %>% 
  mutate(dummy.OpeMode = OpeMode)

# zobrať iba relevantné dáta
total_inc_tec_tsbl <- filter(total_inc_tec_tsbl, TimeStampPosixct > ymd("2019-07-01"))

# add dummmy variables for OpeMode ---------
# which dummy has lowest count - exclude counts = 0 and minimum
OpeMode_counts <- table(total_inc_tec_tsbl$OpeMode)
nonzero_counts <- OpeMode_counts[which(OpeMode_counts > 0)]
names_to_exclude <- str_c("dummy.", ifelse("Idle" %in% names(nonzero_counts), "Idle", names(which.min(nonzero_counts))) )

hourly_inc_tec_tsbl <- total_inc_tec_tsbl %>% 
  # select(TimeStampPosixct, OpeMode) %>% 
  mutate(dummy_value_1 = 1) %>% 
  pivot_wider(names_from = dummy.OpeMode, values_from = dummy_value_1, names_prefix = "dummy.", values_fill = list(dummy_value_1 = 0)) %>% 
  select(-all_of(names_to_exclude)) %>% 
  arrange(TimeStampPosixct) %>% 
  as_tsibble(key = UniqueIdentifier, index = TimeStampPosixct)

return (hourly_inc_tec_tsbl)
})

# data preparation----
buildings_lst <- map(building_data_files_rows$bin_data_file, function(datafile){
  # browser()
  cat("loading datafile", datafile, "\n")
  data_struct <- load(file= datafile)
  cat("preparing outdoor dfs\n")
  outdoor_df_lst <- try(prepare_df_fun(get(data_struct)))
  cat("removing data structure\n")
  return(outdoor_df_lst)
}) %>% 
  set_names(building_data_files_rows$Building)


save(buildings_lst, file = "buildings_lst.Rda")



```

## Evaluating predictors

Try to find predictors
Correlation matrix

```{r Correlation matrix, include=TRUE}
# pair_plot <- total_inc_tec_tsbl %>% 
#   as_tibble() %>% 
#   filter(dummy.worktime ==1) %>%
#   select(-TimeStampPosixct) %>%
#   # select_if(is.numeric) %>% 
#   GGally::ggpairs(aes(color = OpeMode))
# 
# pair_plot


```

Model

```{r functions}
sample_plt <- function(model_fit, model_df, model_setback_df) {result_df <- augment(model_fit)
samples_time <- model_df %>%
  as_tibble() %>% 
  sample_n(10) %>% 
  pull(TimeStampPosixct)

days_range <- case_when(is.POSIXct(samples_time[1]) ~ 2,
                        is.Date(samples_time[1]) ~ 6)

samples_df_lst <- map(samples_time, ~result_df %>% 
                        filter(TimeStampPosixct %within% (.x %--% (.x + days(days_range)))) %>% 
                        ggplot(aes(x = TimeStampPosixct, color = .model, group = .model))+
                        geom_line(aes(y = consumption), color = "black", alpha = 0.5) +
                        geom_line(aes(y = .fitted), alpha = 0.5) + 
                        geom_line(data=filter(model_setback_df, TimeStampPosixct %within% (.x %--% (.x + days(days_range)))), aes(y = consumption), linetype = "dashed")+
                        labs(title = .x)+
                        theme(legend.position = "bottom")
)
# geom_line(data = tsbox::ts_tsibble(forecast::tsclean(tsbox::ts_ts(select(training_set_daily, consumption)))), aes(x = time, y = value), color = "green")

grid_plt <- cowplot::plot_grid(plotlist = samples_df_lst) 
return (grid_plt)
}
```


```{r separate model}

# model_fun <- function (outdoor_df){
# dataset_split <- rsample::initial_time_split(outdoor_df, prop = 3/4)
# training_set <- outdoor_df  
# testing_set <- training_set  
# 
# model_train_df <- training_set  
# 
# model_fit_df <- model_train_df %>% 
#   filter(dummy.Cooling == 1 & dummy.worktime == 1)  
# 
# model_fit_sep <- model_fit_df %>% 
#   model(# for cooling only period include idle
#         # TSLM = TSLM((consumption -0.015) ~ dummy.Cooling:(ambient + average_suction + Tes.mean.value) - 1))
#         TSLM = TSLM(consumption ~ ambient + average_suction + Tes.mean.value + hd + my))
# # for heating only
#         # TSLM = TSLM(consumption ~ ambient + average_suction + Tcs.mean.value))
#         # for idle
#         #TSLM = TSLM(consumption ~ ambient + average_suction + dummy.worktime_out + hd + wd))
#         # daily model whole year: 
#         # TSLM_ext = TSLM(consumption ~ (ambient + average_suction) * (OpeModeDailyRepExt_Cooling_s + OpeModeDailyRepExt_Heating + OpeModeDailyRepExt_Heating_s + OpeModeDailyRepExt_Idle)))
#         # for both models: -1 in formula removes the intercept
#         # TSLM = TSLM(consumption ~ (ambient + average_suction + average_ope_time) * (dummy.Cooling + dummy.Heating) + hd:dummy.Cooling + Tes.mean.value:dummy.Cooling + Tcs.mean.value:dummy.Heating - (ambient + average_suction)))
# # whole year hourly simple
#  # TSLM = TSLM(consumption ~ (ambient + average_suction) * (dummy.Cooling + dummy.Heating) + Tes.mean.value:dummy.Cooling + Tcs.mean.value:dummy.Heating - (ambient + average_suction)-1))
# return(model_fit_sep)
# }

# correlation coefficients -------
corr_coef <- function(df) as_tibble(df) %>% 
  select_if(is.numeric) %>% 
  corrr::correlate() %>% 
  filter(rowname == "consumption") %>% 
  select_if(~any(!is.na(.)))

# add CV to the model accuracy  -------
accuracy_cv_fun <- function(outdoor_df, out_model) mutate(accuracy(out_model), mean_cons = mean(outdoor_df$consumption), CV = RMSE/mean_cons*100)

# add CV to the forecast accuracy -----
fcst_accuracy <- function(forecast_df, new_data_df) {
  accuracy_df <- accuracy(forecast_df, data = new_data_df) %>% 
    mutate(mean_cons = mean(new_data_df$consumption), CV = RMSE/mean_cons*100)
  return(accuracy_df)
}

# function to create dataframe with setback
setback_fun <- function(df, suction_stbck = 2, Te_setback = 0, Tc_setback = 0, ambient_shift = 0) {
  setback_df <- mutate(df, average_setpoint = case_when(OpeMode == "Cooling" ~ average_setpoint+suction_stbck,
                                        OpeMode == "Heating" ~ average_setpoint-suction_stbck,
                                        TRUE ~ average_suction),
           average_suction = case_when(OpeMode == "Cooling" ~ average_suction+suction_stbck,
                                       OpeMode == "Heating" ~ average_suction-suction_stbck,
                                       TRUE ~ average_suction),
           average_suction_opetime = case_when(OpeMode == "Cooling" ~ average_suction_opetime+suction_stbck,
                                               OpeMode == "Heating" ~ average_suction_opetime-suction_stbck,
                                               TRUE ~ average_suction),
           ambient = ambient + ambient_shift)
  if(Te_setback > 0) setback_df <- mutate(setback_df,
           Tes.mean.value = if_else(OpeMode == "Cooling", Tes.mean.value + Te_setback, Tes.mean.value),
           Tes.mean.value = if_else(Tes.mean.value > 11, 11, Tes.mean.value),
           Te.mean.value = if_else(OpeMode == "Cooling", Te.mean.value + Te_setback, Te.mean.value),
           Te.mean.value = if_else(Te.mean.value > 11, 11, Te.mean.value))
  if(Tc_setback > 0) setback_df <- mutate(setback_df,
           Tcs.mean.value = if_else(OpeMode == "Heating", Tcs.mean.value - Tc_setback, Tcs.mean.value),
           Tcs.mean.value = if_else(Tcs.mean.value < 41, 41, Tcs.mean.value),
           Tc.mean.value = if_else(OpeMode == "Heating", Tc.mean.value - Tc_setback, Tc.mean.value),
           Tc.mean.value = if_else(Tc.mean.value < 41, 41, Tc.mean.value))
  return(setback_df)
}

# function to compare real, forecast from training and setback consumption -------
compare_cons_fun <- function (training_df, forecast_real, forecast_stbck){
  real_cons_sum <- sum(training_df$consumption)
  # browser()
  comparison_df <- as_tibble(forecast_real) %>% 
  group_by(.model) %>% 
  summarise(fcst_sum = sum(consumption, na.rm = T)) %>% 
  full_join(forecast_stbck %>% 
  as_tibble() %>% 
  group_by(.model) %>% 
  summarise(fcst_setback_sum = sum(consumption, na.rm = T)) ,
  by = ".model") %>% 
  mutate(real_cons = real_cons_sum, setback_save =(1 - (fcst_setback_sum/fcst_sum))*100)
  return(comparison_df)
}

# function to rename the column for particular mode ------
rename_mode <- function(orig_name, ope_mode) {
  renamed <- str_c(orig_name, "_", str_sub(ope_mode, 1, 4))
  return(renamed)
}

# function to create the forecast dataframe per mode -------
add_mode_columns <- function (df, ope_mode, model_formula){
  # browser()
  df <- mutate(df, data = map(hourly_df, ~filter(.x, OpeMode == ope_mode & dummy.worktime == 1)))
  df <- mutate(df, out_model = map(data, ~try(model(.x, TSLM = TSLM(model_formula)))))
  df <- mutate(df, regr_coef = map(out_model, ~try(coef(.x))))
  df <- mutate(df, mean_consumption = map(data, ~mean(.x$consumption)))
  df <- mutate(df, model_accuracy = map2(data, out_model, ~try(accuracy_cv_fun(.x, .y))))
  df <- mutate(df, forecast_training = map2(out_model, data, ~try(forecast(.x, new_data = .y, times = 100))))
  df <- mutate(df, fcst_training_accuracy = map2(forecast_training, data, ~try(fcst_accuracy(.x, .y))))
  df <- mutate(df, data_stbck = map(data, setback_fun))
  df <- mutate(df, forecast_setback =map2(out_model, data_stbck, ~try(forecast(.x, new_data = .y, times = 100)))) 
  df <- mutate(df, comparison = pmap(list(data, forecast_training, forecast_setback), ~try(compare_cons_fun(..1, ..2, ..3))))
  df <- rename_all(df, ~rename_mode(.x, ope_mode))
}

outdoor_df_lst <- flatten(buildings_lst) %>% 
   keep(~first(class(.x)) == "tbl_ts")

init_results_df <- map_dfr(outdoor_df_lst, function (hourly_df) {distinct(hourly_df, UniqueIdentifier) %>% 
    mutate(hourly_df = list(hourly_df))
})

results_df_Cooling <- add_mode_columns(init_results_df, "Cooling", as.formula(consumption ~ ambient + average_suction + Tes.mean.value + hd + my))

results_df_Cooling %>% 
mutate(alternate_test= map_lgl(comparison_Cool, ~first(class(.x)) == "try-error")) %>% 
  filter(!alternate_test) %>% 
  unnest(model_accuracy_Cool, names_repair = "unique", names_sep = ".") %>% 
  unnest(comparison_Cool, names_repair = "unique", names_sep = ".") %>% 
  select_if(negate(is.list)) %>% 
  flextable::flextable() %>% 
  flextable::set_formatter_type(fmt_double = "%.02f")

results_df_Heating <- add_mode_columns(init_results_df, "Heating", as.formula(consumption ~ ambient + average_suction + Tcs.mean.value + hd + my))

results_df_Heating %>% 
mutate(alternate_test= map_lgl(comparison_Heat, ~first(class(.x)) == "try-error")) %>% 
  filter(!alternate_test) %>% 
  unnest(comparison_Heat, names_repair = "unique", names_sep = ".") %>% 
  select_if(negate(is.list)) %>% 
  flextable::flextable() %>% 
  flextable::set_formatter_type(fmt_double = "%.02f")

```

